# Your Guide: Connect to Arun's PostgreSQL Remotely

**Purpose:** Run Alembic migrations on Arun's database from your PC  
**Time:** 10-15 minutes (including Arun's setup)  
**Prerequisites:** Arun must complete his setup first

---

## Overview

You'll connect to Arun's PostgreSQL database over the network and run the Alembic migrations from your PC.

**Flow:**
```
Your PC → Network → Arun's PC → PostgreSQL → Database Updated
```

---

## Step 1: Arun's Setup (He Does This First)

Send Arun this file: `arun_backend/ARUN-REMOTE-ACCESS-SETUP.md`

**What he needs to do:**
1. Find his IP address (`ipconfig`)
2. Edit PostgreSQL config files
3. Configure Windows Firewall
4. Restart PostgreSQL
5. Share his IP address with you

**Wait for Arun to confirm:** "Setup complete, my IP is `___.___.___.___ `"

---

## Step 2: Update Your .env File

Once Arun shares his IP, update your `.env` file:

**File:** `arun_backend/.env`

**Change from:**
```env
DATABASE_URL=postgresql://postgres:8088@localhost:5432/trajectory
```

**Change to:**
```env
DATABASE_URL=postgresql://postgres:8088@ARUN_IP:5432/trajectory
```

**Example:** If Arun's IP is `192.168.1.100`:
```env
DATABASE_URL=postgresql://postgres:8088@192.168.1.100:5432/trajectory
```

---

## Step 3: Test the Connection

Before running migrations, test if you can connect:

```bash
# Method 1: Using psql (if you have PostgreSQL client installed)
psql -h ARUN_IP -U postgres -d trajectory

# Example:
psql -h 192.168.1.100 -U postgres -d trajectory

# Enter password when prompted: 8088
```

**Expected output:**
```
Password for user postgres:
trajectory=#
```

Type `\q` to exit.

**If you don't have psql installed:**
```bash
# Method 2: Using Python
cd arun_backend/backend
python
```

```python
from sqlalchemy import create_engine
engine = create_engine('postgresql://postgres:8088@ARUN_IP:5432/trajectory')
conn = engine.connect()
print("✅ Connection successful!")
conn.close()
```

---

## Step 4: Install Dependencies on Your PC

```bash
cd arun_backend/backend

# Activate virtual environment (if you have one)
# venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt
```

**Expected output:**
```
Successfully installed alembic-1.13.1 numpy-1.26.4 scikit-learn-1.4.0 pandas-2.2.0
```

---

## Step 5: Verify Alembic Configuration

Check that `alembic.ini` is configured correctly:

**File:** `arun_backend/backend/alembic.ini`

The database URL should be read from your `.env` file automatically (handled by `alembic/env.py`).

**Verify:**
```bash
cd arun_backend/backend
alembic current
```

**Expected output:**
```
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
```

---

## Step 6: Generate Migration

```bash
cd arun_backend/backend
alembic revision --autogenerate -m "Initial schema with alumni and skills tables"
```

**Expected output:**
```
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table 'alumni'
INFO  [alembic.autogenerate.compare] Detected added table 'skills'
INFO  [alembic.autogenerate.compare] Detected added column 'students.updated_at'
  Generating C:\...\alembic\versions\abc123_initial_schema_with_alumni_and_skills_tables.py ...  done
```

---

## Step 7: Review the Migration File

Open the generated file in `alembic/versions/` (it will have a random ID).

**Check that it includes:**
- ✅ Creating `alumni` table
- ✅ Creating `skills` table
- ✅ Adding constraints to `students` table
- ✅ Updating `digital_wellbeing_data` table
- ✅ Updating `trajectory_scores` table
- ✅ Updating `recommendations` table

**Example of what you'll see:**
```python
def upgrade() -> None:
    # ### commands auto generated by Alembic ###
    op.create_table('alumni',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('name', sa.String(), nullable=False),
        # ... more columns
    )
    # ... more operations
```

---

## Step 8: Apply the Migration

```bash
alembic upgrade head
```

**Expected output:**
```
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> abc123, Initial schema with alumni and skills tables
```

**If successful, you'll see no errors!**

---

## Step 9: Verify the Migration

### Method 1: Check Alembic Version
```bash
alembic current
```

**Expected output:**
```
abc123 (head)
```

### Method 2: Check Tables in Database

**If you have psql:**
```bash
psql -h ARUN_IP -U postgres -d trajectory
```

```sql
-- List all tables
\dt

-- You should see:
-- alumni (NEW)
-- skills (NEW)
-- students (UPDATED)
-- digital_wellbeing_data (UPDATED)
-- trajectory_scores (UPDATED)
-- recommendations (UPDATED)
-- alembic_version (NEW)

-- Check alumni table structure
\d alumni

-- Check skills table structure
\d skills

-- Exit
\q
```

### Method 3: Using Python
```python
from app.db import SessionLocal
from app.models import Alumni, Skill

db = SessionLocal()

# Try to query (should not error)
alumni_count = db.query(Alumni).count()
skills_count = db.query(Skill).count()

print(f"✅ Alumni table exists: {alumni_count} records")
print(f"✅ Skills table exists: {skills_count} records")

db.close()
```

---

## Step 10: Test Creating Records

Create test records to verify everything works:

```python
from app.db import SessionLocal
from app.models import Alumni, Skill, PlacementStatusEnum, CompanyTierEnum

db = SessionLocal()

# Test 1: Create Alumni
test_alumni = Alumni(
    name="Test Alumni",
    major="Computer Science",
    graduation_year=2023,
    gpa=8.5,
    attendance=90.0,
    placement_status=PlacementStatusEnum.PLACED,
    company_tier=CompanyTierEnum.TIER1,
    role_title="Software Engineer",
    salary_range="15-20 LPA",
    role_to_major_match_score=95.0
)
db.add(test_alumni)
db.commit()
print(f"✅ Created alumni with ID: {test_alumni.id}")

# Test 2: Create Skill
test_skill = Skill(
    student_id=1,  # Use existing student ID
    skill_name="Python",
    proficiency_score=85.0,
    quiz_score=90.0,
    voice_score=80.0,
    market_weight=2.0,
    market_weight_reasoning="High demand in AI/ML jobs"
)
db.add(test_skill)
db.commit()
print(f"✅ Created skill with ID: {test_skill.id}")

db.close()
```

---

## Troubleshooting

### Issue 1: "Connection refused"

**Possible causes:**
- Arun's PostgreSQL not running
- Arun's firewall blocking connection
- Wrong IP address

**Solutions:**
1. Ask Arun to check PostgreSQL service is running
2. Ask Arun to check firewall settings
3. Verify IP address with Arun (`ipconfig`)
4. Make sure you're on the same network (WiFi/LAN)

### Issue 2: "Connection timed out"

**Possible causes:**
- Not on same network
- Router blocking traffic
- Firewall issue

**Solutions:**
1. Confirm both PCs are on same WiFi/network
2. Ask Arun to temporarily disable firewall (for testing)
3. Try pinging Arun's PC: `ping ARUN_IP`

### Issue 3: "Authentication failed"

**Possible causes:**
- Wrong password
- pg_hba.conf not configured for your IP

**Solutions:**
1. Verify password is `8088`
2. Ask Arun to check pg_hba.conf includes your IP
3. Ask Arun to restart PostgreSQL

### Issue 4: "No changes detected" when generating migration

**Possible causes:**
- Models already match database
- env.py not importing models correctly

**Solutions:**
1. Check that `alembic/env.py` imports `from app.models import Base`
2. Verify `target_metadata = Base.metadata`
3. Make sure you saved `models.py`

### Issue 5: "Table already exists"

**Possible causes:**
- Tables were created manually before
- Migration was run partially

**Solutions:**
```bash
# Mark database as up-to-date without running migration
alembic stamp head
```

---

## After Migration is Complete

### 1. Revert .env (Optional)

If you want to work with a local database later, change `.env` back to:
```env
DATABASE_URL=postgresql://postgres:8088@localhost:5432/trajectory
```

### 2. Commit Migration Files

```bash
git add alembic/versions/*.py
git commit -m "Add initial database migration with alumni and skills tables"
git push
```

### 3. Share with Team

Tell Arun and others:
"Migration complete! The database now has alumni and skills tables. Pull the latest code and you're synced!"

---

## Network Diagram

```
┌─────────────────────────────────────────────────┐
│              Your PC                             │
│                                                  │
│  ┌──────────────────────────────────────────┐  │
│  │  arun_backend/backend/                   │  │
│  │  - alembic/                              │  │
│  │  - app/models.py (updated)               │  │
│  │  - .env (DATABASE_URL=ARUN_IP)           │  │
│  └──────────────────────────────────────────┘  │
│                                                  │
│  Run: alembic upgrade head                      │
└─────────────────┬───────────────────────────────┘
                  │
                  │ Network Connection
                  │ (WiFi/LAN)
                  │
┌─────────────────▼───────────────────────────────┐
│              Arun's PC                           │
│                                                  │
│  ┌──────────────────────────────────────────┐  │
│  │  PostgreSQL Server                       │  │
│  │  - Port: 5432                            │  │
│  │  - Database: trajectory                  │  │
│  │  - User: postgres                        │  │
│  │  - Password: 8088                        │  │
│  └──────────────────────────────────────────┘  │
│                                                  │
│  Tables Created:                                 │
│  ✅ alumni                                       │
│  ✅ skills                                       │
│  ✅ students (updated)                           │
└─────────────────────────────────────────────────┘
```

---

## Summary Checklist

- [ ] Arun completed his setup (ARUN-REMOTE-ACCESS-SETUP.md)
- [ ] Arun shared his IP address with me
- [ ] Updated `.env` with Arun's IP
- [ ] Tested connection to Arun's PostgreSQL
- [ ] Installed dependencies (`pip install -r requirements.txt`)
- [ ] Generated migration (`alembic revision --autogenerate`)
- [ ] Reviewed migration file
- [ ] Applied migration (`alembic upgrade head`)
- [ ] Verified migration (`alembic current`)
- [ ] Tested creating alumni and skill records
- [ ] Committed migration files to Git

---

## Time Estimate

- Arun's setup: 5-10 minutes
- Your setup: 5 minutes
- Running migration: 2 minutes
- Testing: 3 minutes
- **Total: 15-20 minutes**

---

## Next Steps

After successful migration:
1. Continue with remaining tasks (authentication, LLM integration, frontend)
2. Arun can continue developing on his PC with the updated database
3. Team members can pull the migration files and apply them to their databases

---

**Status:** Ready to connect remotely  
**Prerequisites:** Arun must complete ARUN-REMOTE-ACCESS-SETUP.md first  
**Questions?** Check Troubleshooting section or ask for help!

# Alembic Setup Guide for Arun

**Date:** February 18, 2026  
**Purpose:** Set up Alembic for database migrations  
**Status:** Configuration files created âœ…

---

## What I've Done For You

I've set up Alembic in your backend with all the necessary configuration:

### âœ… Files Created:

1. **`alembic.ini`** - Main configuration file
   - Database URL: `postgresql://postgres:8088@localhost:5432/trajectory`
   - Logging configuration
   - Migration script location

2. **`alembic/env.py`** - Environment configuration
   - Imports your models from `app.models`
   - Uses DATABASE_URL from your `.env` file
   - Configures online/offline migration modes

3. **`alembic/script.py.mako`** - Migration template
   - Template for generating migration files

4. **`alembic/README`** - Quick reference guide

5. **`requirements.txt`** - Updated with:
   - `alembic` - Database migration tool
   - `numpy` - For mathematical operations
   - `scikit-learn` - For similarity calculations
   - `pandas` - For data analysis

---

## Step-by-Step Setup (5 minutes)

### Step 1: Install Dependencies

```bash
cd arun_backend/backend

# Activate your virtual environment first
# On Windows:
venv\Scripts\activate

# Then install new packages
pip install -r requirements.txt
```

**Expected output:**
```
Successfully installed alembic-1.13.1 numpy-1.26.4 scikit-learn-1.4.0 pandas-2.2.0
```

### Step 2: Verify Alembic Installation

```bash
alembic --version
```

**Expected output:**
```
alembic 1.13.1
```

### Step 3: Create Initial Migration

This will detect all your current models and create a migration file:

```bash
alembic revision --autogenerate -m "Initial schema with alumni and skills tables"
```

**Expected output:**
```
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table 'alumni'
INFO  [alembic.autogenerate.compare] Detected added table 'skills'
INFO  [alembic.autogenerate.compare] Detected added column 'students.updated_at'
  Generating C:\...\alembic\versions\abc123_initial_schema_with_alumni_and_skills_tables.py ...  done
```

### Step 4: Review the Generated Migration

Open the file in `alembic/versions/` (it will have a random ID like `abc123_initial_schema...py`)

**What to check:**
- âœ… Alumni table is being created
- âœ… Skills table is being created
- âœ… Students table constraints are being added
- âœ… DigitalWellbeingData table is being updated
- âœ… TrajectoryScore table is being updated
- âœ… Recommendations table is being updated

**Example of what you'll see:**
```python
def upgrade() -> None:
    # ### commands auto generated by Alembic ###
    op.create_table('alumni',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('name', sa.String(), nullable=False),
        sa.Column('major', sa.String(), nullable=False),
        # ... more columns
        sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_alumni_major'), 'alumni', ['major'], unique=False)
    # ... more operations
    # ### end Alembic commands ###
```

### Step 5: Apply the Migration

```bash
alembic upgrade head
```

**Expected output:**
```
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> abc123, Initial schema with alumni and skills tables
```

### Step 6: Verify in PostgreSQL

```bash
# Connect to your database
psql -U postgres -d trajectory

# Check tables
\dt

# You should see:
# - alumni (NEW)
# - skills (NEW)
# - students (UPDATED)
# - digital_wellbeing_data (UPDATED)
# - trajectory_scores (UPDATED)
# - recommendations (UPDATED)
# - alembic_version (NEW - tracks migration version)

# Check alumni table structure
\d alumni

# Exit psql
\q
```

---

## Common Commands

### Check Current Migration Version
```bash
alembic current
```

### View Migration History
```bash
alembic history --verbose
```

### Upgrade to Latest Version
```bash
alembic upgrade head
```

### Rollback One Migration
```bash
alembic downgrade -1
```

### Rollback to Specific Version
```bash
alembic downgrade abc123
```

### Create Empty Migration (for manual changes)
```bash
alembic revision -m "Add custom index"
```

### Generate Migration from Model Changes
```bash
alembic revision --autogenerate -m "Add new field to students"
```

---

## Workflow for Future Changes

### Scenario 1: Adding a New Field

1. **Update models.py:**
```python
class Student(Base):
    # ... existing fields
    phone_number = Column(String)  # NEW FIELD
```

2. **Generate migration:**
```bash
alembic revision --autogenerate -m "Add phone number to students"
```

3. **Review the generated file** in `alembic/versions/`

4. **Apply migration:**
```bash
alembic upgrade head
```

### Scenario 2: Adding a New Table

1. **Add to models.py:**
```python
class Course(Base):
    __tablename__ = "courses"
    id = Column(Integer, primary_key=True)
    name = Column(String, nullable=False)
```

2. **Generate migration:**
```bash
alembic revision --autogenerate -m "Add courses table"
```

3. **Apply migration:**
```bash
alembic upgrade head
```

### Scenario 3: Modifying a Column

1. **Update models.py:**
```python
# Change from String to Text
description = Column(Text)  # Was: Column(String)
```

2. **Generate migration:**
```bash
alembic revision --autogenerate -m "Change description to text type"
```

3. **Review and apply:**
```bash
alembic upgrade head
```

---

## Troubleshooting

### Issue 1: "Target database is not up to date"

**Error:**
```
FAILED: Target database is not up to date.
```

**Solution:**
```bash
# Check current version
alembic current

# Upgrade to latest
alembic upgrade head
```

### Issue 2: "Can't locate revision identified by 'abc123'"

**Error:**
```
Can't locate revision identified by 'abc123'
```

**Solution:**
```bash
# Check history
alembic history

# Stamp database with current version
alembic stamp head
```

### Issue 3: "Table already exists"

**Error:**
```
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.DuplicateTable) relation "alumni" already exists
```

**Solution:**
The table was created manually. You have two options:

**Option A: Mark as applied without running**
```bash
alembic stamp head
```

**Option B: Drop and recreate**
```bash
# In psql
DROP TABLE alumni CASCADE;

# Then run migration
alembic upgrade head
```

### Issue 4: "No changes detected"

**Error:**
```
INFO  [alembic.autogenerate.compare] No changes detected
```

**Solution:**
- Make sure you saved `models.py`
- Check that `env.py` imports your models correctly
- Verify database connection in `alembic.ini`

### Issue 5: Migration fails halfway

**Error:**
```
ERROR [alembic.util.messaging] FAILED: ...
```

**Solution:**
```bash
# Check current state
alembic current

# Rollback to previous version
alembic downgrade -1

# Fix the issue in models.py

# Generate new migration
alembic revision --autogenerate -m "Fixed migration"

# Apply again
alembic upgrade head
```

---

## Testing Your Setup

### Test 1: Create Alumni Record

```python
from app.db import SessionLocal
from app.models import Alumni, PlacementStatusEnum, CompanyTierEnum

db = SessionLocal()

test_alumni = Alumni(
    name="Test Alumni",
    major="Computer Science",
    graduation_year=2023,
    gpa=8.5,
    attendance=90.0,
    placement_status=PlacementStatusEnum.PLACED,
    company_tier=CompanyTierEnum.TIER1,
    role_title="Software Engineer",
    salary_range="15-20 LPA",
    role_to_major_match_score=95.0
)

db.add(test_alumni)
db.commit()
print(f"âœ… Created alumni with ID: {test_alumni.id}")
db.close()
```

### Test 2: Create Skill Record

```python
from app.models import Skill

db = SessionLocal()

test_skill = Skill(
    student_id=1,  # Use existing student ID
    skill_name="Python",
    proficiency_score=85.0,
    quiz_score=90.0,
    voice_score=80.0,
    market_weight=2.0,
    market_weight_reasoning="High demand in AI/ML jobs"
)

db.add(test_skill)
db.commit()
print(f"âœ… Created skill with ID: {test_skill.id}")
db.close()
```

### Test 3: Query with New Fields

```python
from app.models import TrajectoryScore, TrendEnum, CompanyTierEnum

db = SessionLocal()

# Create trajectory score with new fields
score = TrajectoryScore(
    student_id=1,
    score=75.5,
    confidence=0.85,
    margin_of_error=5.2,
    trend=TrendEnum.IMPROVING,
    velocity=2.5,
    predicted_tier=CompanyTierEnum.TIER1,
    num_similar_alumni=10
)

db.add(score)
db.commit()
print(f"âœ… Created trajectory score with confidence: {score.confidence}")
db.close()
```

---

## Best Practices

### 1. Always Review Auto-Generated Migrations
Alembic is smart but not perfect. Always check the generated migration file before applying.

### 2. Test on Development First
```bash
# Development
alembic upgrade head  # Test here

# If successful, apply to production
alembic upgrade head
```

### 3. Backup Before Migrations
```bash
# Backup database
pg_dump -U postgres -d trajectory > backup_$(date +%Y%m%d).sql

# Then run migration
alembic upgrade head
```

### 4. Use Descriptive Migration Messages
```bash
# Good
alembic revision --autogenerate -m "Add email verification to users"

# Bad
alembic revision --autogenerate -m "Update"
```

### 5. Commit Migration Files to Git
```bash
git add alembic/versions/*.py
git commit -m "Add migration for alumni and skills tables"
git push
```

### 6. Keep Migrations Small
Don't bundle too many changes in one migration. Smaller migrations are easier to debug and rollback.

---

## Integration with Your Workflow

### Daily Development Workflow

1. **Morning: Pull latest code**
```bash
git pull
alembic upgrade head  # Apply any new migrations
```

2. **During development: Make model changes**
```python
# Edit app/models.py
class Student(Base):
    # Add new field
    linkedin_url = Column(String)
```

3. **Generate migration**
```bash
alembic revision --autogenerate -m "Add linkedin_url to students"
```

4. **Test migration**
```bash
alembic upgrade head
# Test your application
```

5. **Commit changes**
```bash
git add app/models.py alembic/versions/*.py
git commit -m "Add linkedin_url field to students"
git push
```

### Team Collaboration

**Mayur makes changes:**
```bash
# Mayur updates models.py
alembic revision --autogenerate -m "Add courses table"
git push
```

**Arun applies changes:**
```bash
git pull
alembic upgrade head  # Database updated automatically!
```

**Vivek applies changes:**
```bash
git pull
alembic upgrade head  # Database updated automatically!
```

Everyone's database stays in sync! ðŸŽ‰

---

## Next Steps

1. âœ… **Install dependencies** - `pip install -r requirements.txt`
2. âœ… **Generate initial migration** - `alembic revision --autogenerate -m "Initial schema"`
3. âœ… **Review migration file** - Check `alembic/versions/`
4. âœ… **Apply migration** - `alembic upgrade head`
5. âœ… **Test new tables** - Create alumni and skill records
6. âœ… **Commit to Git** - Share with team

---

## Summary

**What Alembic Does:**
- âœ… Automatically detects model changes
- âœ… Generates SQL migration scripts
- âœ… Applies migrations safely
- âœ… Tracks migration history
- âœ… Supports rollbacks
- âœ… Keeps team databases in sync

**Time Saved:**
- Manual SQL: 30-60 minutes per change
- With Alembic: 2-5 minutes per change
- **Savings: 90% less time on database management!**

**Ready to use!** Just run the commands in Step-by-Step Setup above.

---

**Questions?** Check the Troubleshooting section or ask for help!
